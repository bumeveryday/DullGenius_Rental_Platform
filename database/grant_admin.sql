-- [ê´€ë¦¬ì ê¶Œí•œ ë¶€ì—¬ SQL]
-- ì´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ Supabase ëŒ€ì‹œë³´ë“œ -> SQL Editor ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.

-- 1. ì—­í•  í…Œì´ë¸” ë° ì‚¬ìš©ì-ì—­í•  ë§¤í•‘ í…Œì´ë¸” ìƒì„± (ì—†ëŠ” ê²½ìš°)
create table if not exists roles (
  key text primary key,
  display_name text not null,
  permissions jsonb default '[]'
);

create table if not exists user_roles (
  id bigint generated by default as identity primary key,
  user_id uuid references auth.users not null,
  role_key text references roles(key) not null,
  created_at timestamptz default now(),
  unique(user_id, role_key)
);

-- 2. ê¸°ë³¸ admin ì—­í•  ìƒì„± (ì—†ëŠ” ê²½ìš°)
insert into roles (key, display_name, permissions)
values ('admin', 'ê´€ë¦¬ì', '["all"]')
on conflict (key) do nothing;

insert into roles (key, display_name, permissions)
values ('executive', 'ìš´ì˜ì§„', '["manage_games", "approve_rentals"]')
on conflict (key) do nothing;


-- =========================================================
-- ğŸ‘‡ [ì—¬ê¸° ìˆ˜ì •!] ë³¸ì¸ì˜ ì´ë©”ì¼ì„ ì•„ë˜ì— ì…ë ¥í•˜ì„¸ìš”.
-- =========================================================
do $$
declare
  target_email text := 'admin@example.com'; -- ë³¸ì¸ ì´ë©”ì¼ë¡œ ë³€ê²½í•˜ì„¸ìš”!
  target_user_id uuid;
begin
  -- ì´ë©”ì¼ë¡œ user_id ì°¾ê¸°
  select id into target_user_id from auth.users where email = target_email;

  if target_user_id is not null then
    -- admin ê¶Œí•œ ë¶€ì—¬
    insert into user_roles (user_id, role_key)
    values (target_user_id, 'admin')
    on conflict (user_id, role_key) do nothing;
    
    raise notice 'âœ… [%] ë‹˜ì—ê²Œ ê´€ë¦¬ì(admin) ê¶Œí•œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.', target_email;
  else
    raise warning 'âŒ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì´ë©”ì¼ [%]ì´ ì •í™•í•œì§€ í™•ì¸í•˜ì„¸ìš”.', target_email;
  end if;
end $$;
